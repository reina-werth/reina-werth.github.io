<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teachable Machine Image Classification</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ml5@2.3.0/dist/ml5.min.js"></script>
</head>
<body>
    <h1>Upload an Image to Classify</h1>
    
    <!-- Single image upload button -->
    <input type="file" id="fileInput" onchange="handleFile(event)">
    
    <!-- Canvas to display the image -->
    <div id="canvas-container"></div>
    
    <!-- Classification results -->
    <div id="classification-result">
        <p><strong>Label:</strong> <span id="label">Waiting...</span></p>
        <p><strong>Confidence:</strong> <span id="confidence">0.00</span></p>
    </div>

    <script>
        let classifier;
        let label = "Waiting for Image...";
        let confidence = 0.0;
        let img;
        const modelURL = 'https://teachablemachine.withgoogle.com/models/R1ff7lXqa/';

        // STEP 1: Load the model once the page is ready
        function preload() {
            console.log("Loading model...");
            classifier = ml5.imageClassifier(modelURL + 'model.json', modelLoaded);
        }

        // STEP 2: This function will be called when the model is loaded
        function modelLoaded() {
            console.log("Model Loaded!");
            // Update the label to let the user know the model is ready
            document.getElementById('label').textContent = "Model Loaded!";
        }

        // STEP 3: Handle the file input and trigger classification
        function handleFile(event) {
            let file = event.target.files[0];  // Get the file from the input
            if (file && file.type.startsWith('image')) {  // Check if the file is an image
                // Create an img element to display the uploaded image
                img = createImg(URL.createObjectURL(file), 'Uploaded Image');
                img.hide();  // Hide the image (we only display it on the canvas)

                // Ensure image is loaded before drawing
                img.onload = () => {
                    // Create the canvas and draw the image
                    createCanvas(640, 520);
                    image(img, 0, 0, width, height);  // Draw the uploaded image on the canvas

                    // Classify the uploaded image using the model
                    console.log("Classifying image...");
                    classifier.classify(img, gotResults);
                };
            } else {
                alert("Please upload a valid image.");
            }
        }

        // STEP 4: Handle the classification result
        function gotResults(error, results) {
            if (error) {
                console.error("Error during classification:", error);
                return;
            }
            console.log("Results:", results);

            label = results[0].label;
            confidence = nf(results[0].confidence, 0, 2);

            // Display the result in the page
            document.getElementById('label').textContent = label;
            document.getElementById('confidence').textContent = confidence;
        }

        // Initialize the model when the page is ready
        window.onload = function() {
            preload();  // Preload the model when the page is loaded
        };
    </script>
</body>
</html>
